name: Deploy Frontend to AWS EC2

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches:
      - dev
      - main

jobs:
  # Deploy to dev environment
  deploy_dev:
    name: Deploy DEV Environment
    if: github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Deploy Frontend to EC2 (dev)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            export ENVIRONMENT=dev
            export NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            export NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            export NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            
            cd /home/ec2-user
            echo "Removing previous frontend deployment..."
            sudo rm -rf academic-saas-frontend
            
            echo "Cloning frontend repository (PR branch: ${{ github.event.pull_request.head.ref }})..."
            git clone --depth 1 --branch ${{ github.event.pull_request.head.ref }} --single-branch https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository_owner }}/academic-saas-frontend.git academic-saas-frontend
            
            cd academic-saas-frontend
            
            echo "Creating environment file..."
            cat > .env.production << EOF
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NODE_ENV=production
            EOF
            
            echo "Building Docker image..."
            sudo docker build \
              --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
              --build-arg NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
              --build-arg NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} \
              -t academic-saas-frontend:dev .
            
            echo "Stopping existing frontend containers..."
            sudo docker stop academic-saas-frontend-dev || true
            sudo docker rm academic-saas-frontend-dev || true
            
            echo "Starting frontend container..."
            sudo docker run -d \
              --name academic-saas-frontend-dev \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
              -e NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
              -e NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} \
              -e NODE_ENV=production \
              academic-saas-frontend:dev
            
            echo "Waiting for frontend to start..."
            sleep 10
            
            echo "Health check..."
            curl -f http://localhost:3000 || echo "Health check warning: Frontend may still be starting"
            
            echo "DEV frontend deployment finished."

  # Deploy to production environment
  deploy_prod:
    name: Deploy PROD Environment
    if: |
      github.event.pull_request.base.ref == 'main' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Deploy Frontend to EC2 (prod)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_PROD }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            export ENVIRONMENT=prod
            export NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            export NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            export NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            
            cd /home/ec2-user
            echo "Creating backup of current frontend deployment..."
            if [ -d academic-saas-frontend ]; then
              sudo cp -r academic-saas-frontend academic-saas-frontend-backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            echo "Removing previous frontend deployment..."
            sudo rm -rf academic-saas-frontend
            
            echo "Cloning frontend repository (main branch)..."
            git clone --depth 1 --branch main --single-branch https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository_owner }}/academic-saas-frontend.git academic-saas-frontend
            
            cd academic-saas-frontend
            
            echo "Creating production environment file..."
            cat > .env.production << EOF
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NODE_ENV=production
            EOF
            
            echo "Building Docker image..."
            sudo docker build \
              --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
              --build-arg NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
              --build-arg NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} \
              -t academic-saas-frontend:prod .
            
            echo "Stopping existing frontend containers..."
            sudo docker stop academic-saas-frontend-prod || true
            sudo docker rm academic-saas-frontend-prod || true
            
            echo "Starting frontend container..."
            sudo docker run -d \
              --name academic-saas-frontend-prod \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
              -e NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
              -e NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }} \
              -e NODE_ENV=production \
              academic-saas-frontend:prod
            
            echo "Waiting for frontend to start..."
            sleep 30
            
            echo "Health check..."
            curl -f http://localhost:3000 || (echo "Frontend health check failed" && exit 1)
            
            echo "PROD frontend deployment finished."

  # Cleanup old images and backups
  cleanup:
    name: Cleanup Docker Images
    needs: [deploy_dev, deploy_prod]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Cleanup on DEV server
        if: github.event.pull_request.base.ref == 'dev'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Cleaning up old Docker images..."
            sudo docker image prune -f
            sudo docker system prune -f --volumes
            
            echo "Removing old backups (keeping last 5)..."
            cd /home/ec2-user
            ls -dt academic-saas-frontend-backup-* 2>/dev/null | tail -n +6 | xargs sudo rm -rf
      
      - name: Cleanup on PROD server
        if: |
          github.event.pull_request.base.ref == 'main' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_PROD }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Cleaning up old Docker images..."
            sudo docker image prune -f
            sudo docker system prune -f --volumes
            
            echo "Removing old backups (keeping last 5)..."
            cd /home/ec2-user
            ls -dt academic-saas-frontend-backup-* 2>/dev/null | tail -n +6 | xargs sudo rm -rf